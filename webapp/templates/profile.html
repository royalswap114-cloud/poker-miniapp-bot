<script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        let tg;
        try {
            tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
        } catch (e) {
            console.error('Telegram WebApp ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
        }
        
        function updateUserInfo() {
            const userNameEl = document.getElementById('userName');
            const userIdEl = document.getElementById('userId');
            
            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const user = tg.initDataUnsafe.user;
                userNameEl.textContent = (user.first_name || '') + (user.last_name ? ' ' + user.last_name : '') || 'ì‚¬ìš©ì';
                userIdEl.textContent = 'ID: ' + user.id;
            } else {
                userNameEl.textContent = 'ì‚¬ìš©ì';
                userIdEl.textContent = 'WebApp ì •ë³´ ë¡œë”© ì¤‘...';
                setTimeout(updateUserInfo, 500);
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', updateUserInfo);
        } else {
            updateUserInfo();
        }
        
        async function handleCoupon(e) {
            e.preventDefault();
            if (!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user) {
                alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const response = await fetch('/api/coupons/' + tg.initDataUnsafe.user.id);
            const coupons = await response.json();
            if (coupons.length === 0) {
                tg.showAlert('ë³´ìœ í•œ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤.');
            } else {
                let msg = 'ğŸŸï¸ ë³´ìœ  ì¿ í° (' + coupons.length + 'ê°œ)\n\n';
                coupons.forEach(c => { msg += 'â€¢ ' + c.title + '\n  ' + c.amount.toLocaleString() + 'ì›\n\n'; });
                tg.showAlert(msg);
            }
        }
        
        function handleEvent(e) {
            e.preventDefault();
            window.location.href = '/events';
        }
        
        function openTelegramProfile(e) {
            e.preventDefault();
            if (!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user || !tg.initDataUnsafe.user.username) {
                tg.showAlert('í…”ë ˆê·¸ë¨ ì‚¬ìš©ìëª…ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            tg.openTelegramLink('https://t.me/' + tg.initDataUnsafe.user.username);
        }
    </script>
</body>
</html>